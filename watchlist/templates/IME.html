{% extends 'base.html' %}

{% block content %}
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="stylesheet" href="../static/css/article_add.css" />
<link rel="stylesheet" href="../static/css/article_list.css" />


<div id="Login" style="text-align: center;">
    <h3>拼音输入法</h3>
    <!-- <h5>支持全声母（准确率极低），给个面子：尽量输入<font color='red'>全部完整拼音</font></h5> -->
    <h5>本次加载HMM模型耗时<font color='purple'>{{ load_time }}</font>s</h5>
    <input class="input-form txt" type="text" placeholder="请输入拼音，需要手动分词请用'号隔开" style="width: 800px"
        name="sentence" required 
        onkeyup="if(event.keyCode != 222) PinyinDivide();">
    <input class=" input-form prebtn" style="width: 80px;" type="button" value="预测">
    <input class="input-form clearbtn" style="width: 80px;" type="button" value="清空">
    <!-- <input class="input-form" style="width: 80px;" type="submit" name="submit" value="清空"> -->
</div>
<!-- 
{% for (word, prob) in best_list %}
<div id="word-prob-{{ loop.index }}" style="padding: 2px 5px; border-radius: 3px; text-align: center;">
    <h4>The top <font color='blue'>{{ loop.index }}</font> word is <font color='blue'>{{ word }}</font>, its probability
        is {{ prob }}.</h4>
</div>
{% endfor %} -->

<div class="result_list">
</div>


<script type="text/javascript">
    function PinyinDivide() {
        var originText = $(".txt").val();
        // var str = "h'qiangan'yu's'h'n'y";
        var str = originText;

        var resArray = new Array();
        var py;
        var strArray = str.split("\'");
        for (i = 0; i < strArray.length; i++) {
            // /pat/g match返回的是所有匹配的内容，正则没有g简化返回的格式时，使用match()返回的信息比较多。
            // 但是有g后，就没有关键的信息index了。
            // 而exec方法就能解决这个问题，它能接着上一次匹配后继续匹配，搭配while循环
            var pat = /[jqlyx]u[en]|kun|hun|nue|er|[^aoeiuv]?h?[iv]?(ai|ei|ao|ou|ang?|eng?|ong|on?|a|o?|e|i|u|ng|n)?/g;
            while (py = pat.exec(strArray[i])) {
                if (py[0] == "") {
                    break;
                }
                //特殊情况 卷舌翘舌
                if (py[0].length == 2 && py[0][1] == "h" && py[0] != "zh" && py[0] != "sh" && py[0] != "ch") {
                    for (j = 0; j < py[0].length; j++) {
                        resArray.push(py[0][j]);
                    }
                }
                else {
                    resArray.push(py[0]);
                }
                console.log(py, pat.lastIndex);
            }
        }
        $(".txt").val( resArray.join("\'") );
    }

    //搜索结果局部刷新	
    $(function () {
        // 绑定回车键   
        $('.txt').keydown(function (event) {
            if (event.keyCode == 13) {
                console.log("test!");
                $(".prebtn").click();
            }
        });

        $('.prebtn').click(function () {
            var word = $('.txt').val();
            var data = {
                data: JSON.stringify({
                    'sentence': word,
                }),
            };

            $.ajax({
                type: 'POST',
                url: "{{ url_for('.IME_POST') }}",
                data: data,  // 这个data是要post的数据
                success: function (result) {  // 这个data是接收到的响应的实体
                    // 移去原来的列表
                    $('.result_list .item').remove();
                    console.log(result["best_list"]);
                    // 列表循环
                    $.each(result['best_list'], function (index, item) {
                        $(".result_list").append(
                            "<div class='item' style='padding: 2px 5px; border-radius: 3px; text-align: center;'>" +
                            "<h4>The top <font color='blue'>" + index + "</font> word is <font color='blue'>" +
                            item[0] + "</font>, its probability is " + item[1] + ".</h4></div>"
                        );
                    });
                    // $('.result').val(data['youdao']);
                }
            });
        });
    });

    //点击清空输入框
    $('.clearbtn').on('click', function () {
        // $('.result').html('');
        $('.txt').val('');
    })
</script>

{% endblock %}